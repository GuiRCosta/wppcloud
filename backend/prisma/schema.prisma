// ============================================
// PRISMA SCHEMA - WhatsApp Chat Application
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  SUPERVISOR
  AGENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum OnlineStatus {
  ONLINE
  AWAY
  BUSY
  OFFLINE
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  STICKER
  LOCATION
  CONTACTS
  INTERACTIVE
  TEMPLATE
  REACTION
  UNKNOWN
}

// ============================================
// ORGANIZATION & TEAMS
// ============================================

model Organization {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  logo            String?
  timezone        String   @default("America/Sao_Paulo")
  
  // WhatsApp Configuration
  wabaId          String?  @map("waba_id")
  phoneNumberId   String?  @map("phone_number_id")
  phoneNumber     String?  @map("phone_number")
  accessToken     String?  @map("access_token")
  webhookSecret   String?  @map("webhook_secret")
  
  // Settings
  settings        Json     @default("{}")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  users           User[]
  teams           Team[]
  conversations   Conversation[]
  quickReplies    QuickReply[]
  tags            Tag[]

  @@map("organizations")
}

model Team {
  id              String       @id @default(uuid())
  organizationId  String       @map("organization_id")
  name            String
  description     String?
  color           String       @default("#3B82F6")
  
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members         TeamMember[]

  @@map("teams")
}

model TeamMember {
  id        String   @id @default(uuid())
  teamId    String   @map("team_id")
  userId    String   @map("user_id")
  role      String   @default("member")
  
  createdAt DateTime @default(now()) @map("created_at")

  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id              String       @id @default(uuid())
  organizationId  String       @map("organization_id")
  
  // Authentication
  email           String       @unique
  passwordHash    String       @map("password_hash")
  emailVerified   Boolean      @default(false) @map("email_verified")
  emailVerifiedAt DateTime?    @map("email_verified_at")
  
  // Profile
  firstName       String       @map("first_name")
  lastName        String       @map("last_name")
  displayName     String?      @map("display_name")
  avatar          String?
  phone           String?
  
  // Status & Role
  role            UserRole     @default(AGENT)
  status          UserStatus   @default(ACTIVE)
  onlineStatus    OnlineStatus @default(OFFLINE) @map("online_status")
  lastSeenAt      DateTime?    @map("last_seen_at")
  
  // 2FA
  twoFactorEnabled Boolean     @default(false) @map("two_factor_enabled")
  twoFactorSecret  String?     @map("two_factor_secret")
  
  // Settings
  settings        Json         @default("{}")
  
  // Timestamps
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  lastLoginAt     DateTime?    @map("last_login_at")

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teams           TeamMember[]
  sessions        Session[]
  assignedConversations Conversation[] @relation("AssignedAgent")
  messages        Message[]    @relation("SentByAgent")
  notes           Note[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  
  refreshToken String   @unique @map("refresh_token")
  
  // Device Info
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")
  deviceType   String?  @map("device_type")
  
  expiresAt    DateTime @map("expires_at")
  lastActivity DateTime @default(now()) @map("last_activity")
  
  createdAt    DateTime @default(now()) @map("created_at")
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([refreshToken])
  @@index([userId])
  @@map("sessions")
}

model PasswordReset {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([token])
  @@index([email])
  @@map("password_resets")
}

// ============================================
// CONVERSATIONS & MESSAGES
// ============================================

model Contact {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  
  waId            String   @map("wa_id")
  phoneNumber     String   @map("phone_number")
  profileName     String?  @map("profile_name")
  profilePicture  String?  @map("profile_picture")
  
  // Custom fields
  email           String?
  customName      String?  @map("custom_name")
  notes           String?
  metadata        Json     @default("{}")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  conversations   Conversation[]

  @@unique([organizationId, waId])
  @@index([organizationId])
  @@index([waId])
  @@map("contacts")
}

model Conversation {
  id              String             @id @default(uuid())
  organizationId  String             @map("organization_id")
  contactId       String             @map("contact_id")
  
  // Status
  status          ConversationStatus @default(OPEN)
  priority        Int                @default(0)
  
  // Assignment
  assignedToId    String?            @map("assigned_to_id")
  
  // Last message info (denormalized for performance)
  lastMessageAt   DateTime?          @map("last_message_at")
  lastMessagePreview String?         @map("last_message_preview")
  lastMessageType MessageType?       @map("last_message_type")
  unreadCount     Int                @default(0) @map("unread_count")
  
  // 24h window tracking
  windowExpiresAt DateTime?          @map("window_expires_at")
  
  // Timestamps
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  resolvedAt      DateTime?          @map("resolved_at")
  closedAt        DateTime?          @map("closed_at")

  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact         Contact            @relation(fields: [contactId], references: [id], onDelete: Cascade)
  assignedTo      User?              @relation("AssignedAgent", fields: [assignedToId], references: [id])
  messages        Message[]
  tags            ConversationTag[]
  notes           Note[]

  @@index([organizationId])
  @@index([contactId])
  @@index([status])
  @@index([assignedToId])
  @@index([lastMessageAt])
  @@map("conversations")
}

model Message {
  id              String           @id @default(uuid())
  conversationId  String           @map("conversation_id")
  
  // WhatsApp IDs
  wamid           String?          @unique
  contextWamid    String?          @map("context_wamid")
  
  // Message details
  type            MessageType
  direction       MessageDirection
  status          MessageStatus    @default(PENDING)
  
  // Content (JSON structure varies by type)
  content         Json
  
  // Metadata
  timestamp       DateTime
  sentById        String?          @map("sent_by_id")
  
  // Error tracking
  errorCode       String?          @map("error_code")
  errorMessage    String?          @map("error_message")
  
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  conversation    Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sentBy          User?            @relation("SentByAgent", fields: [sentById], references: [id])
  media           Media[]

  @@index([conversationId])
  @@index([wamid])
  @@index([timestamp])
  @@map("messages")
}

model Media {
  id          String   @id @default(uuid())
  messageId   String   @map("message_id")
  
  // Meta's media ID
  mediaId     String?  @map("media_id")
  
  // File info
  type        String
  mimeType    String   @map("mime_type")
  fileName    String?  @map("file_name")
  fileSize    Int?     @map("file_size")
  
  // URLs
  url         String?
  localPath   String?  @map("local_path")
  
  // Checksum
  sha256      String?
  
  createdAt   DateTime @default(now()) @map("created_at")

  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([mediaId])
  @@map("media")
}

// ============================================
// TAGS & NOTES
// ============================================

model Tag {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  
  name            String
  color           String   @default("#6B7280")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversations   ConversationTag[]

  @@unique([organizationId, name])
  @@map("tags")
}

model ConversationTag {
  id              String       @id @default(uuid())
  conversationId  String       @map("conversation_id")
  tagId           String       @map("tag_id")
  
  createdAt       DateTime     @default(now()) @map("created_at")

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  tag             Tag          @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([conversationId, tagId])
  @@map("conversation_tags")
}

model Note {
  id              String       @id @default(uuid())
  conversationId  String       @map("conversation_id")
  userId          String       @map("user_id")
  
  content         String
  
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("notes")
}

// ============================================
// QUICK REPLIES & TEMPLATES
// ============================================

model QuickReply {
  id              String       @id @default(uuid())
  organizationId  String       @map("organization_id")
  
  shortcut        String
  title           String
  content         String
  category        String?
  
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, shortcut])
  @@map("quick_replies")
}

model Template {
  id              String   @id @default(uuid())
  
  // Meta's template info
  templateId      String   @unique @map("template_id")
  name            String
  language        String
  category        String
  status          String
  
  // Components (header, body, footer, buttons)
  components      Json
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("templates")
}

// ============================================
// WEBHOOK LOGS
// ============================================

model WebhookLog {
  id          String   @id @default(uuid())
  
  entryId     String   @map("entry_id")
  eventType   String   @map("event_type")
  payload     Json
  
  processed   Boolean  @default(false)
  processedAt DateTime? @map("processed_at")
  error       String?
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([entryId])
  @@index([processed])
  @@index([createdAt])
  @@map("webhook_logs")
}

